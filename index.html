<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <!-- VIEWPORT OTTIMIZZATO PER MOBILE -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    
    <!-- META PER PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a237e">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA MANIFEST -->
    <link rel="manifest" href="manifest.json">
    
    <title>Dashboard Polisportiva Juvenilia</title>
    
    <!-- FAVICON -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <style>
        /* RESET */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body, html {
            font-family: 'Poppins', sans-serif;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #2c3e50;
        }
        
        :root {
            --primary: #1a237e;
            --secondary: #283593;
            --accent: #5c6bc0;
            --success: #43e97b;
            --warning: #ffb74d;
            --danger: #f44336;
        }
        
        /* HEADER */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; 
            padding: 25px 20px;
            text-align: center;
            border-bottom-left-radius: 20px; 
            border-bottom-right-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); 
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .logo-header {
            height: 100px;
            width: auto;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
            margin-bottom: 15px;
            border-radius: 15px;
            background: white;
            padding: 10px;
        }
        
        .header-content h1 {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* CONTROLLI */
        .reorder-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px auto 30px;
            padding: 0 20px;
            max-width: 500px;
            flex-wrap: wrap;
        }
        
        .reorder-btn {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.2);
            min-height: 44px;
            flex: 1;
            min-width: 140px;
            justify-content: center;
        }
        
        .reorder-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 35, 126, 0.3);
        }
        
        .reorder-btn.active {
            background: linear-gradient(135deg, #43e97b, #38ef7d);
        }
        
        /* CONTAINER */
        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            gap: 20px;
            width: 100%;
        }
        
        /* CARD */
        .race-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            border: 2px solid transparent;
        }
        
        .race-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }
        
        .card-header {
            padding: 30px 25px;
            color: white;
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
            text-transform: uppercase;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .card-number {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .reorder-buttons {
            position: absolute;
            top: 10px;
            left: 10px;
            display: none;
            gap: 8px;
            z-index: 10;
        }
        
        .reorder-mode .reorder-buttons {
            display: flex;
        }
        
        .move-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .move-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .card-body {
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-grow: 1;
        }
        
        /* PULSANTI */
        .btn {
            padding: 15px 20px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
            width: 100%;
            min-height: 52px;
        }
        
        .btn-main {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            box-shadow: 0 4px 15px rgba(26, 35, 126, 0.3);
        }
        
        .btn-copy {
            background: linear-gradient(135deg, #f0f2f5, #e4e7ec);
            color: #2c3e50;
            border: 2px solid transparent;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        
        .btn-copy.success {
            background: linear-gradient(135deg, #43e97b, #38ef7d);
            color: white;
        }
        
        /* COLORI */
        .color-1 { background: linear-gradient(135deg, #667eea, #764ba2); }
        .color-2 { background: linear-gradient(135deg, #f5576c, #f093fb); }
        .color-3 { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .color-4 { background: linear-gradient(135deg, #43e97b, #38ef7d); }
        .color-5 { background: linear-gradient(135deg, #fa709a, #fee140); }
        
        /* LOADER */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            gap: 25px;
            transition: opacity 0.3s ease;
        }
        
        .spinner {
            width: 70px;
            height: 70px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* NOTIFICA */
        #notif {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, var(--success), #2ecc71);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            display: none;
            z-index: 3000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            font-weight: 600;
            animation: slideUp 0.3s ease-out forwards;
            max-width: 300px;
            text-align: center;
        }
        
        @keyframes slideUp {
            to { transform: translateX(-50%) translateY(0); }
        }
        
        /* FOOTER */
        .footer {
            text-align: center;
            padding: 30px 20px;
            margin-top: 60px;
            color: #7f8c8d;
            font-size: 0.9rem;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 0 15px;
            }
            
            header {
                padding: 20px 15px;
            }
            
            .logo-header {
                height: 80px;
            }
            
            .header-content h1 {
                font-size: 1.5rem;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            }
        }
        
        @media (min-width: 1025px) {
            .container {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            }
        }
        
        /* DEBUG PULSANTI */
        .debug-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-size: 0.8rem;
            z-index: 1000;
            display: none;
        }
        
        .sync-status.online { border-left: 4px solid #43e97b; }
        .sync-status.offline { border-left: 4px solid #f44336; }
    </style>
</head>
<body>

    <!-- DEBUG STATUS -->
    <div id="syncStatus" class="sync-status">
        <i class="fas fa-circle"></i> <span id="syncText">Checking...</span>
    </div>

    <!-- DEBUG BUTTON -->
    <button id="debugBtn" class="debug-btn" onclick="debugSync()">
        <i class="fas fa-bug"></i> Debug
    </button>

    <!-- LOADER -->
    <div id="loader" class="animate__animated animate__fadeIn">
        <div class="spinner"></div>
        <div class="loading-text">
            <p>Caricamento dashboard...</p>
            <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;">Connessione a Supabase</p>
        </div>
    </div>

    <!-- HEADER -->
    <header class="animate__animated animate__fadeInDown">
        <img src="logo.png" alt="Logo Polisportiva Juvenilia" class="logo-header" 
             onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><rect width=\"100\" height=\"100\" fill=\"%231a237e\"/><text x=\"50\" y=\"50\" font-family=\"Arial\" font-size=\"24\" fill=\"white\" text-anchor=\"middle\" dy=\".3em\">üèÜ</text></svg>'">
        <div class="header-content">
            <h1>Dashboard Gare Juvenilia</h1>
            <p>Gestione sincronizzata delle manifestazioni sportive</p>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main>
        <div class="reorder-controls">
            <button id="toggle-reorder" class="reorder-btn">
                <i class="fas fa-sort"></i>
                <span id="reorder-text">Modalit√† Riordina</span>
            </button>
            <button id="save-order" class="reorder-btn" style="display: none;">
                <i class="fas fa-save"></i>
                Salva & Sincronizza
            </button>
            <button id="reset-order" class="reorder-btn" style="display: none;">
                <i class="fas fa-undo"></i>
                Reset
            </button>
        </div>
        
        <div class="reorder-info" id="reorder-info" style="text-align: center; margin: 10px auto 30px; max-width: 500px; padding: 0 20px; color: #666; display: none;">
            <i class="fas fa-info-circle"></i> Clicca sulle frecce per spostare le card. Clicca "Salva & Sincronizza" per salvare su tutti i dispositivi.
        </div>

        <div class="container" id="race-grid">
            <!-- Le card verranno caricate qui -->
        </div>
    </main>

    <!-- NOTIFICATION -->
    <div id="notif" role="alert" aria-live="polite"></div>

    <!-- FOOTER -->
    <footer class="footer animate__animated animate__fadeInUp">
        <p>¬© 2024 Polisportiva Juvenilia - Sistema sincronizzato v2.0</p>
        <p style="margin-top: 10px; font-size: 0.8rem; opacity: 0.7;">
            <span id="syncIndicator"><i class="fas fa-sync-alt"></i> Sincronizzazione: <span id="syncState">Attiva</span></span> | 
            <span id="deviceInfo">Dispositivo: <span id="deviceType">Rilevamento...</span></span>
        </p>
    </footer>

    <script>
        // ============================================
        // CONFIGURAZIONE SUPABASE SEMPLIFICATA
        // ============================================
        const SUPABASE_URL = 'https://jnfnfszekfstuoiemkgf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuZm5mc3pla2ZzdHVvaWVta2dmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4ODkzOTEsImV4cCI6MjA4MzQ2NTM5MX0.lh7eRFlg7nnI7kEzVPBL9kNyZWX-XFeWQxVbvmzRlvA';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ============================================
        // VARIABILI GLOBALI
        // ============================================
        let currentUserId = null;
        let deviceType = 'desktop';
        let isReorderMode = false;
        let originalOrder = [];
        let currentOrder = [];
        let racesData = [];
        
        // ============================================
        // FUNZIONI DI UTILITY
        // ============================================
        
        // Genera o recupera User ID
        function getUserId() {
            if (!currentUserId) {
                let userId = localStorage.getItem('juvenilia_user_id_v2');
                if (!userId) {
                    userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('juvenilia_user_id_v2', userId);
                }
                currentUserId = userId;
                
                // Aggiorna UI
                document.getElementById('syncIndicator').innerHTML = 
                    `<i class="fas fa-user"></i> ID: ${userId.substring(0, 8)}...`;
            }
            return currentUserId;
        }
        
        // Rileva dispositivo
        function detectDevice() {
            const width = window.innerWidth;
            if (width <= 768) {
                deviceType = 'mobile';
            } else if (width <= 1024) {
                deviceType = 'tablet';
            } else {
                deviceType = 'desktop';
            }
            
            document.getElementById('deviceType').textContent = deviceType;
            return deviceType;
        }
        
        // Mostra notifica
        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notif');
            
            let bgColor = 'linear-gradient(135deg, var(--success), #2ecc71)';
            if (type === 'warning') bgColor = 'linear-gradient(135deg, var(--warning), #ff9800)';
            if (type === 'error') bgColor = 'linear-gradient(135deg, var(--danger), #d32f2f)';
            if (type === 'info') bgColor = 'linear-gradient(135deg, var(--accent), #5c6bc0)';
            
            notif.style.background = bgColor;
            notif.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 
                type === 'warning' ? 'exclamation-triangle' : 
                type === 'error' ? 'times-circle' : 'info-circle'}"></i> ${message}`;
            notif.style.display = 'block';
            
            setTimeout(() => {
                notif.style.display = 'none';
            }, 3000);
        }
        
        // Mostra/nascondi loader
        function showLoader(show) {
            const loader = document.getElementById('loader');
            loader.style.display = show ? 'flex' : 'none';
        }
        
        // Aggiorna stato sincronizzazione
        function updateSyncStatus(online = true) {
            const statusEl = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            const syncState = document.getElementById('syncState');
            
            if (online) {
                statusEl.className = 'sync-status online';
                statusEl.style.display = 'block';
                syncText.textContent = 'Online - Sincronizzato';
                syncState.textContent = 'Online';
                syncState.style.color = '#43e97b';
            } else {
                statusEl.className = 'sync-status offline';
                statusEl.style.display = 'block';
                syncText.textContent = 'Offline - Solo locale';
                syncState.textContent = 'Offline';
                syncState.style.color = '#f44336';
            }
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
        
        // ============================================
        // FUNZIONI SINCRONIZZAZIONE CLOUD
        // ============================================
        
        // SALVA ORDINE NEL CLOUD (VERSIONE SEMPLIFICATA)
        async function saveOrderToCloud() {
            const userId = getUserId();
            
            // Crea dati ordine
            const orderData = {
                order: currentOrder,
                device: deviceType,
                timestamp: Date.now(),
                version: '2.0'
            };
            
            console.log('üì° Tentativo salvataggio cloud:', { userId, deviceType });
            
            try {
                // PRIMA: Salva sempre in localStorage (fallback)
                localStorage.setItem('racesCustomOrder_v2', JSON.stringify(orderData));
                
                // SECONDO: Prova a salvare su Supabase (se online)
                if (!navigator.onLine) {
                    showNotification('Salvato localmente (offline)', 'warning');
                    return false;
                }
                
                // Verifica se la tabella esiste e RLS √® configurato correttamente
                const { data, error } = await supabase
                    .from('user_preferences')
                    .upsert({
                        user_id: userId,
                        device_type: deviceType,
                        order_preference: orderData,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id,device_type',
                        ignoreDuplicates: false
                    });
                
                if (error) {
                    console.error('‚ùå Errore Supabase:', error);
                    
                    // Gestione specifica errori RLS
                    if (error.code === '42501' || error.message.includes('permission denied')) {
                        showNotification('Errore permessi DB. Usando salvataggio locale.', 'warning');
                        return false;
                    }
                    
                    throw error;
                }
                
                console.log('‚úÖ Salvataggio cloud riuscito:', data);
                showNotification('Ordine salvato e sincronizzato!', 'success');
                updateSyncStatus(true);
                return true;
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Errore salvataggio cloud, uso fallback locale:', error);
                showNotification('Salvato localmente (errore cloud)', 'warning');
                return false;
            }
        }
        
        // CARICA ORDINE DAL CLOUD
        async function loadOrderFromCloud() {
            const userId = getUserId();
            
            if (!navigator.onLine) {
                console.log('üì¥ Offline, carico da localStorage');
                return loadOrderFromLocal();
            }
            
            try {
                console.log('üì° Caricamento ordine dal cloud per:', userId);
                
                const { data, error } = await supabase
                    .from('user_preferences')
                    .select('order_preference')
                    .eq('user_id', userId)
                    .order('updated_at', { ascending: false })
                    .limit(1);
                
                if (error) {
                    console.warn('‚ö†Ô∏è Errore caricamento cloud:', error);
                    return loadOrderFromLocal();
                }
                
                if (data && data.length > 0 && data[0].order_preference) {
                    const cloudOrder = data[0].order_preference;
                    console.log('‚úÖ Ordine cloud trovato:', cloudOrder);
                    
                    // Salva in localStorage per cache
                    localStorage.setItem('racesCustomOrder_v2', JSON.stringify(cloudOrder));
                    
                    // Controlla se √® pi√π recente del locale
                    const localOrder = localStorage.getItem('racesCustomOrder_v2');
                    if (localOrder) {
                        const localData = JSON.parse(localOrder);
                        if (cloudOrder.timestamp > (localData.timestamp || 0)) {
                            console.log('üîÑ Usando ordine cloud (pi√π recente)');
                            return cloudOrder.order;
                        }
                    }
                    
                    return cloudOrder.order;
                }
                
                console.log('‚ÑπÔ∏è Nessun ordine trovato nel cloud');
                return loadOrderFromLocal();
                
            } catch (error) {
                console.error('üí• Errore caricamento:', error);
                return loadOrderFromLocal();
            }
        }
        
        // CARICA ORDINE LOCALE
        function loadOrderFromLocal() {
            try {
                const savedOrder = localStorage.getItem('racesCustomOrder_v2');
                if (savedOrder) {
                    const orderData = JSON.parse(savedOrder);
                    return orderData.order || [];
                }
            } catch (e) {
                console.warn('Errore parsing ordine locale:', e);
            }
            return null;
        }
        
        // SINCRONIZZAZIONE AUTOMATICA
        async function syncOrdersAcrossDevices() {
            if (!navigator.onLine) return;
            
            try {
                const userId = getUserId();
                console.log('üîÑ Sincronizzazione automatica per:', userId);
                
                const { data, error } = await supabase
                    .from('user_preferences')
                    .select('*')
                    .eq('user_id', userId)
                    .order('updated_at', { ascending: false });
                
                if (error) {
                    console.warn('‚ùå Errore sincronizzazione:', error);
                    return;
                }
                
                if (data && data.length > 0) {
                    const latestOrder = data[0];
                    const localOrder = localStorage.getItem('racesCustomOrder_v2');
                    
                    // Se nessun ordine locale o il cloud √® pi√π recente
                    if (!localOrder || 
                        (latestOrder.order_preference.timestamp > 
                         JSON.parse(localOrder).timestamp)) {
                        
                        console.log('üîÑ Aggiornamento da cloud');
                        localStorage.setItem('racesCustomOrder_v2', 
                            JSON.stringify(latestOrder.order_preference));
                        
                        // Ricarica la griglia se necessario
                        if (racesData.length > 0 && !isReorderMode) {
                            renderRaceGrid();
                            showNotification('Ordine aggiornato da altro dispositivo', 'info');
                        }
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Sincronizzazione fallita:', error);
            }
        }
        
        // ============================================
        // SISTEMA RIORDINO
        // ============================================
        
        function toggleReorderMode() {
            isReorderMode = !isReorderMode;
            const toggleBtn = document.getElementById('toggle-reorder');
            const saveBtn = document.getElementById('save-order');
            const resetBtn = document.getElementById('reset-order');
            const infoEl = document.getElementById('reorder-info');
            
            if (isReorderMode) {
                // Attiva modalit√†
                toggleBtn.classList.add('active');
                toggleBtn.innerHTML = '<i class="fas fa-times"></i> Esci da Modalit√†';
                saveBtn.style.display = 'flex';
                resetBtn.style.display = 'flex';
                infoEl.style.display = 'block';
                
                // Attiva su tutte le card
                document.querySelectorAll('.race-card').forEach(card => {
                    card.classList.add('reorder-mode');
                });
                
                // Salva ordine originale
                saveOriginalOrder();
                
                showNotification('Modalit√† riordina attiva', 'info');
            } else {
                // Disattiva modalit√†
                toggleBtn.classList.remove('active');
                toggleBtn.innerHTML = '<i class="fas fa-sort"></i> Modalit√† Riordina';
                saveBtn.style.display = 'none';
                resetBtn.style.display = 'none';
                infoEl.style.display = 'none';
                
                document.querySelectorAll('.race-card').forEach(card => {
                    card.classList.remove('reorder-mode');
                });
            }
        }
        
        function saveOriginalOrder() {
            const cards = Array.from(document.querySelectorAll('.race-card'));
            originalOrder = cards.map(card => card.id);
            currentOrder = [...originalOrder];
        }
        
        function moveCardUp(cardId) {
            const container = document.getElementById('race-grid');
            const cards = Array.from(container.querySelectorAll('.race-card'));
            const index = cards.findIndex(card => card.id === cardId);
            
            if (index > 0) {
                // Sposta
                const temp = currentOrder[index];
                currentOrder[index] = currentOrder[index - 1];
                currentOrder[index - 1] = temp;
                
                // Aggiorna UI
                container.insertBefore(cards[index], cards[index - 1]);
                updateMoveButtons();
            }
        }
        
        function moveCardDown(cardId) {
            const container = document.getElementById('race-grid');
            const cards = Array.from(container.querySelectorAll('.race-card'));
            const index = cards.findIndex(card => card.id === cardId);
            
            if (index < cards.length - 1) {
                // Sposta
                const temp = currentOrder[index];
                currentOrder[index] = currentOrder[index + 1];
                currentOrder[index + 1] = temp;
                
                // Aggiorna UI
                container.insertBefore(cards[index + 1], cards[index]);
                updateMoveButtons();
            }
        }
        
        function updateMoveButtons() {
            const cards = document.querySelectorAll('.race-card');
            cards.forEach((card, index) => {
                const upBtn = card.querySelector('.move-btn.up');
                const downBtn = card.querySelector('.move-btn.down');
                
                if (upBtn) {
                    upBtn.disabled = index === 0;
                    upBtn.style.opacity = index === 0 ? '0.5' : '1';
                }
                if (downBtn) {
                    downBtn.disabled = index === cards.length - 1;
                    downBtn.style.opacity = index === cards.length - 1 ? '0.5' : '1';
                }
            });
        }
        
        function resetOrder() {
            if (confirm('Ripristinare l\'ordine originale?')) {
                const container = document.getElementById('race-grid');
                
                // Riordina per raceNumber
                const cards = Array.from(container.querySelectorAll('.race-card'));
                cards.sort((a, b) => {
                    return parseInt(a.dataset.raceNumber) - parseInt(b.dataset.raceNumber);
                });
                
                cards.forEach(card => container.appendChild(card));
                
                updateMoveButtons();
                localStorage.removeItem('racesCustomOrder_v2');
                
                showNotification('Ordine ripristinato', 'info');
                toggleReorderMode();
            }
        }
        
        // ============================================
        // CARICAMENTO GARE
        // ============================================
        
        async function loadRaces() {
            showLoader(true);
            
            try {
                // Prima carica l'ordine
                const customOrder = await loadOrderFromCloud();
                
                // Poi carica i dati delle gare
                const { data: tables, error: tableError } = await supabase.rpc('get_race_tables');
                
                if (tableError) throw tableError;
                
                if (!tables || tables.length === 0) {
                    showNoRacesMessage();
                    return;
                }
                
                // Prende i titoli
                const titlePromises = tables.map(t => 
                    supabase
                        .from(t.table_name)
                        .select('valore')
                        .eq('chiave', 'titolo_gara')
                        .maybeSingle()
                );
                
                const results = await Promise.all(titlePromises);
                
                racesData = results.map((res, index) => {
                    const tableName = tables[index].table_name;
                    const raceNumber = tableName.match(/\d+/) ? tableName.match(/\d+/)[0] : (index + 1);
                    const raceTitle = (res.data && res.data.valore) ? res.data.valore : `Gara ${raceNumber}`;
                    
                    return {
                        tableName,
                        raceNumber: parseInt(raceNumber),
                        raceTitle,
                        fileName: `gara${raceNumber}.html`,
                        id: `race-${raceNumber}`
                    };
                });
                
                // Ordina
                racesData.sort((a, b) => a.raceNumber - b.raceNumber);
                
                // Applica ordine personalizzato se esiste
                if (customOrder && customOrder.length > 0) {
                    const orderedRaces = [];
                    const raceMap = {};
                    
                    racesData.forEach(race => raceMap[race.id] = race);
                    
                    // Aggiungi quelli nell'ordine personalizzato
                    customOrder.forEach(id => {
                        if (raceMap[id]) {
                            orderedRaces.push(raceMap[id]);
                            delete raceMap[id];
                        }
                    });
                    
                    // Aggiungi quelli rimanenti
                    Object.values(raceMap).forEach(race => {
                        orderedRaces.push(race);
                    });
                    
                    racesData = orderedRaces;
                }
                
                renderRaceGrid();
                
            } catch (error) {
                console.error('Errore caricamento gare:', error);
                showNotification('Errore caricamento dati', 'error');
                showErrorMessage();
            } finally {
                showLoader(false);
                updateSyncStatus(navigator.onLine);
            }
        }
        
        function renderRaceGrid() {
            const grid = document.getElementById('race-grid');
            const raceIcons = ['üèÜ', '‚öΩ', 'üéØ', 'üèÉ', 'üèä', 'üö¥', 'ü§∏', 'üéæ'];
            
            grid.innerHTML = '';
            currentOrder = [];
            
            racesData.forEach((race, index) => {
                const colorIndex = (index % 5) + 1;
                const icon = raceIcons[index % raceIcons.length];
                
                const card = document.createElement('div');
                card.className = 'race-card animate__animated animate__fadeInUp';
                card.id = race.id;
                card.dataset.raceNumber = race.raceNumber;
                card.style.animationDelay = `${Math.min(index * 0.05, 0.5)}s`;
                
                card.innerHTML = `
                    <div class="reorder-buttons">
                        <button class="move-btn up" onclick="moveCardUp('${race.id}')">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="move-btn down" onclick="moveCardDown('${race.id}')">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </div>
                    <div class="card-header color-${colorIndex}">
                        <div class="card-number">${race.raceNumber}</div>
                        <div class="card-logo" style="font-size: 2rem; margin-bottom: 10px;">${icon}</div>
                        ${race.raceTitle}
                    </div>
                    <div class="card-body">
                        <a href="${race.fileName}" class="btn btn-main">
                            <i class="fas fa-users"></i> Gestisci Iscrizioni
                        </a>
                        <button class="btn btn-copy" onclick="copyLink('${race.fileName}', ${race.raceNumber})">
                            <i class="fas fa-link"></i> Copia Link
                        </button>
                    </div>
                `;
                
                grid.appendChild(card);
                currentOrder.push(race.id);
            });
            
            originalOrder = [...currentOrder];
        }
        
        function showNoRacesMessage() {
            const grid = document.getElementById('race-grid');
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                    <i class="fas fa-trophy" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                    <h3 style="color: #666; margin-bottom: 10px;">Nessuna gara configurata</h3>
                    <p style="color: #888; margin-bottom: 20px;">Contatta l'amministratore del sistema</p>
                    <button onclick="location.reload()" class="reorder-btn" style="max-width: 200px; margin: 0 auto;">
                        <i class="fas fa-redo"></i> Ricarica
                    </button>
                </div>`;
        }
        
        function showErrorMessage() {
            const grid = document.getElementById('race-grid');
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f5576c; margin-bottom: 20px;"></i>
                    <h3 style="color: #666; margin-bottom: 10px;">Errore di connessione</h3>
                    <p style="color: #888; margin-bottom: 20px;">Verifica la connessione internet e riprova</p>
                    <button onclick="loadRaces()" class="reorder-btn" style="max-width: 200px; margin: 0 auto;">
                        <i class="fas fa-sync-alt"></i> Riprova
                    </button>
                </div>`;
        }
        
        // ============================================
        // FUNZIONI AUSILIARIE
        // ============================================
        
        function copyLink(fileName, raceNumber) {
            const fullUrl = window.location.origin + '/' + fileName;
            
            navigator.clipboard.writeText(fullUrl)
                .then(() => {
                    showNotification(`Link gara ${raceNumber} copiato!`, 'success');
                    
                    // Feedback visivo sul pulsante
                    const btns = document.querySelectorAll(`.btn-copy`);
                    btns.forEach(btn => {
                        if (btn.textContent.includes('Copia Link')) {
                            btn.innerHTML = '<i class="fas fa-check"></i> Copiato!';
                            btn.classList.add('success');
                            
                            setTimeout(() => {
                                btn.innerHTML = '<i class="fas fa-link"></i> Copia Link';
                                btn.classList.remove('success');
                            }, 2000);
                        }
                    });
                })
                .catch(err => {
                    console.error('Errore copia:', err);
                    showNotification('Errore nella copia', 'error');
                });
        }
        
        // DEBUG FUNCTIONS
        async function debugSync() {
            console.clear();
            console.log('======= DEBUG SYNC =======');
            
            const userId = getUserId();
            console.log('User ID:', userId);
            console.log('Device:', deviceType);
            console.log('Online:', navigator.onLine);
            console.log('Local Storage ID:', localStorage.getItem('juvenilia_user_id_v2'));
            
            // Test Supabase connection
            try {
                console.log('\nüîó Test connessione Supabase...');
                const { data, error } = await supabase
                    .from('user_preferences')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    console.error('‚ùå Supabase error:', error);
                    showNotification(`DB Error: ${error.message}`, 'error');
                } else {
                    console.log('‚úÖ Supabase connesso');
                }
                
                // Check current user data
                console.log('\nüìä Dati utente corrente...');
                const { data: userData, error: userError } = await supabase
                    .from('user_preferences')
                    .select('*')
                    .eq('user_id', userId);
                
                console.log('Dati trovati:', userData);
                console.log('Errore:', userError);
                
                // Test write
                console.log('\n‚úèÔ∏è Test scrittura...');
                const testData = {
                    user_id: userId,
                    device_type: deviceType,
                    order_preference: { test: 'debug', timestamp: Date.now() }
                };
                
                const { data: writeData, error: writeError } = await supabase
                    .from('user_preferences')
                    .upsert(testData, { onConflict: 'user_id,device_type' });
                
                if (writeError) {
                    console.error('‚ùå Write error:', writeError);
                    showNotification(`Write failed: ${writeError.message}`, 'error');
                } else {
                    console.log('‚úÖ Write successful:', writeData);
                    showNotification('Debug: Scrittura test riuscita', 'success');
                }
                
            } catch (error) {
                console.error('üí• Debug error:', error);
                showNotification('Debug error', 'error');
            }
            
            console.log('==========================');
        }
        
        // ============================================
        // INIZIALIZZAZIONE
        // ============================================
        
        async function initApp() {
            console.log('üöÄ Inizializzazione app...');
            
            // Setup base
            getUserId();
            detectDevice();
            
            // Event listeners
            document.getElementById('toggle-reorder').addEventListener('click', toggleReorderMode);
            document.getElementById('save-order').addEventListener('click', async () => {
                const saved = await saveOrderToCloud();
                if (saved) {
                    toggleReorderMode();
                }
            });
            document.getElementById('reset-order').addEventListener('click', resetOrder);
            
            // Network listeners
            window.addEventListener('online', () => {
                updateSyncStatus(true);
                showNotification('Connessione ripristinata', 'success');
                setTimeout(syncOrdersAcrossDevices, 2000);
            });
            
            window.addEventListener('offline', () => {
                updateSyncStatus(false);
                showNotification('Connessione persa', 'warning');
            });
            
            // Carica dati
            await loadRaces();
            
            // Sincronizzazione periodica
            setInterval(syncOrdersAcrossDevices, 60000); // Ogni minuto
            
            // Sincronizza al ritorno in foreground
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && navigator.onLine) {
                    setTimeout(syncOrdersAcrossDevices, 1000);
                }
            });
            
            console.log('‚úÖ App inizializzata');
        }
        
        // Avvia app quando DOM √® pronto
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Export per debug
        window.debugApp = {
            sync: syncOrdersAcrossDevices,
            save: saveOrderToCloud,
            load: loadRaces,
            reset: () => {
                localStorage.clear();
                location.reload();
            },
            userId: getUserId
        };
        
        console.log('üì± Juvenilia Dashboard v2.0 loaded');
    </script>
</body>
</html>
